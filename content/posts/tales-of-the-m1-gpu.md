+++
title = '[è¯‘] å…³äº M1 GPU çš„æ•…äº‹'
date = 2022-11-29T13:40:40+08:00
draft = false
aliases = ["/post/773516f4-ec40-474e-9c9f-9f96398c9e3e"]
+++
å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æœæ—¥ä¸½å¥ˆï¼

marcan è®©æˆ‘å†™ä¸€ç¯‡å…³äº M1 GPU çš„æ–‡ç« ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ­¤è§é¢äº†ï½ï¼åœ¨è¿‡å»çš„å‡ ä¸ªæœˆé‡Œï¼Œæˆ‘ä»¬èµ°è¿‡äº†æ¼«é•¿çš„é“è·¯ï¼Œæœ‰è®¸å¤šå†…å®¹è¦è®²ã€‚æˆ‘å¸Œæœ›ä½ ä»¬èƒ½å–œæ¬¢ï¼

![Xonotic running on an Apple M2](https://oss.yuchanns.xyz/images/image_627553df-9b54-4142-babf-995c046d82c9.png)

##  ä»€ä¹ˆæ˜¯ GPU ?

ä¹Ÿè®¸ä½ çŸ¥é“ä»€ä¹ˆæ˜¯ GPU ï¼Œä½†ä½ çŸ¥é“å®ƒä»¬å†…åœ¨çš„å·¥ä½œæœºåˆ¶å—ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å§ï¼å‡ ä¹æ‰€æœ‰çš„ç°ä»£ GPU éƒ½æœ‰ç€ç›¸åŒçš„ä¸»è¦éƒ¨ä»¶ï¼š

* ä¸€ç»„ç€è‰²å™¨æ ¸å¿ƒ (*shader cores*) ï¼Œé€šè¿‡è¿è¡Œç”¨æˆ·å®šä¹‰çš„ç¨‹åºæ¥å¤„ç†ä¸‰è§’å½¢ (é¡¶ç‚¹æ•°æ® *vertex data*) å’Œåƒç´  (ç‰‡æ®µæ•°æ® *fragment data*ï¼‰ã€‚è¿™äº›ç¨‹åºåœ¨æ¯ä¸ª GPU ä¸Šéƒ½ä½¿ç”¨äº†ä¸åŒçš„è‡ªå®šä¹‰æŒ‡ä»¤é›†ï¼

* æ …æ ¼åŒ–å•å…ƒ (*rasterization units*)ã€çº¹ç†é‡‡æ ·å™¨ (*texture samplers*)ã€æ¸²æŸ“è¾“å‡ºå•å…ƒ (*render output units*) å’Œå…¶ä»–ä¸€äº›ä¸ç€è‰²å™¨ä¸€èµ·å·¥ä½œçš„ä¸œè¥¿ï¼Œå°†åº”ç”¨ä¸­çš„ä¸‰è§’å½¢è½¬åŒ–ä¸ºå±å¹•ä¸Šçš„åƒç´ ã€‚å…·ä½“çš„å·¥ä½œæ–¹å¼å›  GPU è€Œå¼‚ï¼

* ä¸€ä¸ªå‘½ä»¤å¤„ç†å™¨ (*command processor*) ï¼Œè·å–æ¥è‡ªåº”ç”¨çš„ç»˜åˆ¶å‘½ä»¤ï¼Œå°†å…¶è®¾ç½®åˆ°ç€è‰²å™¨æ ¸å¿ƒè¿›è¡Œå¤„ç†ã€‚è¿™åŒ…æ‹¬äº†è¯¸å¦‚éœ€è¦ç»˜åˆ¶å“ªä¸€ç»„ä¸‰è§’å½¢ã€ä½¿ç”¨ä»€ä¹ˆå…¨å±€å±æ€§ã€ä½¿ç”¨ä»€ä¹ˆçº¹ç†ã€ä½¿ç”¨ä»€ä¹ˆç€è‰²å™¨ç¨‹åºï¼Œä»¥åŠæœ€ç»ˆå›¾åƒåœ¨å†…å­˜ä¸­çš„ä½ç½®ç­‰æ•°æ®ã€‚ç„¶åå®ƒå°†æ•°æ®å‘é€ç»™ç€è‰²å™¨æ ¸å¿ƒä»¥åŠå…¶ä»–å•å…ƒï¼Œä»¥ä¾¿æ“ä½œ GPU è¿›è¡Œå®é™…çš„æ¸²æŸ“ã€‚

* ä¸€ä¸ªå†…å­˜ç®¡ç†å•å…ƒ (*memory management unit, MMU*) ï¼Œè´Ÿè´£é™åˆ¶ç‰¹å®šåº”ç”¨åœ¨ä½¿ç”¨ GPU æ—¶è®¿é—®çš„å†…å­˜åŒºåŸŸã€‚è¿™æ ·ä¸åŒçš„åº”ç”¨é—´æ‰ä¸ä¼šç›¸äº’å†²çªæˆ–å¹²æ‰°ã€‚

(è¿™é‡Œè¿›è¡Œäº†ç®€åŒ–ï¼Œå®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šéƒ¨åˆ†å›  GPU ä¸åŒè€Œä¸åŒï¼Œä½†è¿™é‡Œæåˆ°çš„æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼)

ä¸ºäº†ä»¥åˆç†çš„ã€æœ€å®‰å…¨çš„æ–¹å¼ä¸è¿™äº›æ´»åŠ¨éƒ¨ä»¶æ‰“äº¤é“ï¼Œç°ä»£ GPU é©±åŠ¨åˆ†æˆäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼šç”¨æˆ·ç©ºé—´é©±åŠ¨ (*user space driver*) å’Œå†…æ ¸é©±åŠ¨ (*kernel driver*) ã€‚ç”¨æˆ·ç©ºé—´é©±åŠ¨è´Ÿè´£ç¼–è¯‘ç€è‰²å™¨ç¨‹åºå¹¶å°† API è°ƒç”¨ (ä¾‹å¦‚ OpenGL æˆ– Vulkan) ç¿»è¯‘æˆä¸€ç»„ç‰¹å®šçš„å‘½ä»¤ï¼Œä¹‹åå°†è¢«å‘½ä»¤å¤„ç†å™¨ç”¨æ¥æ¸²æŸ“åœºæ™¯ã€‚åŒæ—¶ï¼Œå†…æ ¸é©±åŠ¨è´Ÿè´£ç®¡ç† MMU å’Œå¤„ç†ä¸åŒåº”ç”¨çš„å†…å­˜çš„åˆ†é…å’Œå†åˆ†é…ï¼Œå¹¶å†³å®šä»¥ä½•ç§æ–¹å¼ä½•æ—¶å°†å‘½ä»¤å‘é€ç»™å‘½ä»¤å¤„ç†å™¨ã€‚æ‰€æœ‰ç°ä»£ GPU é©±åŠ¨éƒ½æ˜¯å¦‚æ­¤å·¥ä½œçš„ï¼Œåœ¨ä¸»æµæ“ä½œç³»ç»Ÿä¸Šï¼

åœ¨ç”¨æˆ·ç©ºé—´é©±åŠ¨å’Œå†…æ ¸é©±åŠ¨ä¹‹é—´å­˜åœ¨ç€æŸç§ä¸ºä¸åŒ GPU ç³»åˆ—å®šåˆ¶çš„ API ã€‚è¿™äº› API é€šå¸¸å¯¹æ¯ä¸ªé©±åŠ¨ç¨‹åºéƒ½æ˜¯ä¸åŒçš„ï¼åœ¨ Linux æˆ‘ä»¬ç§°ä¹‹ä¸º UAPI ï¼Œä½†åœ¨æ¯ä¸ªæ“ä½œç³»ç»Ÿé‡Œéƒ½æœ‰ç±»ä¼¼çš„ä¸œè¥¿ã€‚UAPI ä½¿ç”¨æˆ·ç©ºé—´é©±åŠ¨å¾—ä»¥å‘å†…æ ¸é©±åŠ¨è¯·æ±‚å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ä»¥åŠå‘ GPU æäº¤å‘½ä»¤ã€‚

è¿™æ„å‘³ç€å¦‚æœè¦è®© M1 GPU èƒ½åœ¨ Asahi Linux ä¸­å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªå†…æ ¸é©±åŠ¨å’Œä¸€ä¸ªç”¨æˆ·ç©ºé—´é©±åŠ¨ï¼ğŸš€

##  Alyssa åŠ å…¥åˆ°é¡¹ç›®ä¸­

å›åˆ°2021å¹´ Asahi Linux é¡¹ç›®åˆšå¯åŠ¨çš„æ—¶å€™ï¼ŒAlyssa Rosenzweig åŠ å…¥åˆ°äº†é¡¹ç›®ä¸­å¼€å§‹è¿›è¡Œå¯¹ M1 GPU çš„é€†å‘å·¥ç¨‹ã€‚ä¸ [Dougall Johnson](https://mastodon.social/@dougall) (ä¸€ä¸ªä¸“æ³¨äºç¼–å†™ GPU ç€è‰²å™¨æ¶æ„æ–‡æ¡£çš„äºº) ä¸€èµ·ï¼Œå¥¹å¼€å§‹é€†å‘æ‰€æœ‰ç”¨æˆ·ç©ºé—´çš„ä¸œè¥¿ã€‚è¿™åŒ…æ‹¬ç€è‰²å™¨å’Œæ‰€æœ‰ä¸ºäº†è®¾ç½®æ¸²æŸ“éœ€è¦çš„å‘½ä»¤ç»„ç»“æ„ã€‚è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„å·¥ç¨‹ï¼Œè€Œå¥¹å´åœ¨ä¸åˆ°ä¸€ä¸ªæœˆçš„æ—¶é—´é‡Œå°±[å·²ç»èƒ½å¤Ÿç»˜åˆ¶å‡ºç¬¬ä¸€ä¸ªä¸‰è§’å½¢ï¼](https://rosenzweig.io/blog/asahi-gpu-part-2.html)å¥¹çœŸæ˜¯å¤ªäº†ä¸èµ·äº†ï¼å¦‚æœä½ è¿˜ä¸çŸ¥é“å¥¹å…³äºå‰–æ M1 GPU çš„ç³»åˆ—æ–‡ç« æˆ‘å»ºè®®ä½ è®¿é—®å¥¹çš„[ç½‘ç«™](https://rosenzweig.io/)çœ‹ä¸€çœ‹ï¼âœ¨âœ¨

ä½†æ˜¯ç­‰ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰å†…æ ¸é©±åŠ¨çš„é…åˆï¼Œå¥¹æ€ä¹ˆèƒ½åœ¨ç”¨æˆ·ç©ºé—´é©±åŠ¨ä¸Šå·¥ä½œï¼Ÿå¾ˆç®€å•ï¼Œå¥¹åœ¨ macOS ä¸Šè¿›è¡Œï¼ Alyssa å¯¹ macOS çš„ GPU é©±åŠ¨ UAPI è¿›è¡Œäº†é€†å‘å·¥ç¨‹ï¼Œè¶³ä»¥åˆ†é…å†…å­˜å¹¶å‘ GPU æäº¤å¥¹è‡ªå·±çš„å‘½ä»¤ï¼Œè¿™æ ·å¥¹å°±å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´éƒ¨åˆ†å·¥ä½œè€Œä¸å¿…æ‹…å¿ƒå†…æ ¸éƒ¨åˆ†ã€‚è¿™è¶…çº§é…·ï¼å¥¹å¼€å§‹ç»™ [Mesa](https://www.mesa3d.org/) (Linux ç”¨æˆ·ç©ºé—´å›¾å½¢æŠ€æœ¯æ ˆ) ç¼–å†™ä¸€ä¸ª M1 GPU OpenGL çš„é©±åŠ¨ã€‚ä»…ä»…å‡ ä¸ªæœˆåï¼Œå¥¹å°±å·²ç»[é€šè¿‡ 75% çš„ OpenGL ES2 ä¸€è‡´æ€§æµ‹è¯•](https://rosenzweig.io/blog/asahi-gpu-part-4.html)ï¼Œéƒ½æ˜¯åœ¨ macOS ä¸Šè¿›è¡Œçš„ï¼

ä»Šå¹´æ—©äº›æ—¶å€™ï¼Œå¥¹çš„å·¥ä½œå®åœ¨è¶…å‰ï¼Œç”šè‡³äºå¥¹å¯ä»¥åœ¨ä¸€ä¸ªå®Œå…¨å¼€æºçš„ Mesa OpenGL æŠ€æœ¯æ ˆä¸Šè¿è¡Œ[æ¸¸æˆ](https://rosenzweig.io/blog/asahi-gpu-part-6.html)ï¼Œåœ¨è‹¹æœçš„ macOS çš„å†…æ ¸é©±åŠ¨ä¸Šè¿è¡Œï¼ä½†æ˜¯æˆ‘ä»¬ä»ç„¶æ²¡æœ‰ Linux çš„å†…æ ¸é©±åŠ¨â€¦â€¦æ˜¯æ—¶å€™è§£å†³è¿™ä¸ªé—®é¢˜äº†! âœ¨

##  ç¥ç§˜çš„ GPU å›ºä»¶

åœ¨ä»Šå¹´4æœˆä»½ï¼Œæˆ‘å†³å®šå¼€å§‹å°è¯•å¼„æ¸…æ¥šå¦‚ä½•ç¼–å†™ä¸€ä¸ª M1 GPU å†…æ ¸é©±åŠ¨ï¼å½“æˆ‘å¼€å§‹å·¥ä½œçš„æ—¶å€™ [Scott Mansell](https://github.com/phire) å·²ç»å®Œæˆäº†ä¸€äº›ä¾¦æŸ¥å·¥ä½œâ€¦â€¦å¹¶ä¸”å¾ˆæ˜¾ç„¶è¿™ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„ GPU ã€‚åœ¨æœ€åˆçš„å‡ ä¸ªæœˆé‡Œï¼Œæˆ‘è‡´åŠ›äºç¼–å†™å’Œæ”¹è¿›ç”¨äº GPU çš„ [m1n1 hyperisor](https://asahilinux.org/2021/08/progress-report-august-2021/#hardware-reverse-engineering-with-the-m1n1-hypervisor) è·Ÿè¸ªå™¨ï¼Œç„¶åæˆ‘å‘ç°äº†ä¸€äº›åœ¨ GPU ä¸–ç•Œä¸­éå¸¸ã€éå¸¸ä¸å¯»å¸¸çš„ä¸œè¥¿ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼ŒGPU é©±åŠ¨è´Ÿè´£ä¸€äº›ç»†èŠ‚å·¥ä½œï¼Œå¦‚è°ƒåº¦å’Œå†³å®š GPU ä¸Šä½œä¸šçš„ä¼˜å…ˆçº§ï¼Œå¹¶åœ¨ä½œä¸šè¿è¡Œæ—¶é—´è¿‡é•¿æ—¶è¿›è¡ŒæŠ¢å ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿå…¬å¹³åœ°ä½¿ç”¨ GPU ã€‚æœ‰æ—¶é©±åŠ¨ä¼šè´Ÿè´£ç”µæºç®¡ç†ï¼Œæœ‰æ—¶è¿™ç”±è¿è¡Œåœ¨ç”µæºç®¡ç†åå¤„ç†å™¨ä¸Šçš„ä¸“é—¨å›ºä»¶å®Œæˆã€‚æœ‰æ—¶è¿˜ä¼šæœ‰å…¶ä»–å›ºä»¶è´Ÿè´£å‘½ä»¤å¤„ç†çš„ä¸€äº›ç»†èŠ‚ï¼Œä½†å¤§å¤šæ•°å¯¹å†…æ ¸é©±åŠ¨éƒ½æ˜¯ä¸å¯è§çš„ã€‚æœ€åï¼Œå°¤å…¶æ˜¯å¯¹äºåƒ ARM Mali è¿™æ ·æ¯”è¾ƒç®€å•çš„"ç§»åŠ¨å¼" GPU æ¥è¯´ï¼Œè®© GPU æ¸²æŸ“ä¸œè¥¿çš„å®é™…ç¡¬ä»¶æ¥å£é€šå¸¸éå¸¸ç®€å•ã€‚æœ‰ä¸€ä¸ª MMU ï¼Œå®ƒåƒæ ‡å‡†çš„ CPU MMU æˆ– IOMMU ä¸€æ ·å·¥ä½œï¼Œç„¶åå‘½ä»¤å¤„ç†å™¨é€šå¸¸åœ¨æŸç§å¯„å­˜å™¨æˆ–ç¯å½¢ç¼“å†²åŒºä¸­ç›´æ¥æŒ‡å‘ç”¨æˆ·ç©ºé—´å‘½ä»¤ç¼“å†²åŒºã€‚å› æ­¤ï¼Œå†…æ ¸é©±åŠ¨å®é™…å¹¶ä¸éœ€è¦åšå¤ªå¤šé™¤ç®¡ç†å†…å­˜å’Œ GPU è°ƒåº¦ä¹‹å¤–çš„äº‹æƒ…ï¼Œè€Œä¸” Linux å†…æ ¸çš„ DRM (ç›´æ¥æ¸²æŸ“ç®¡ç†å™¨) å­ç³»ç»Ÿå·²ç»æä¾›äº†å¤§é‡çš„åŠ©æ‰‹ï¼Œä½¿ç¼–å†™é©±åŠ¨å˜å¾—å¾ˆå®¹æ˜“ï¼è™½ç„¶ä»æœ‰ä¸€äº›æ£˜æ‰‹çš„é—®é¢˜ï¼Œå¦‚æŠ¢å ï¼Œç„¶è€Œè¿™äº›å¹¶ä¸æ˜¯è®© GPU åœ¨ä¸€ä¸ªå…¨æ–°çš„é©±åŠ¨ä¸­å·¥ä½œçš„å…³é”®ã€‚ä½† M1 GPU æ˜¯ä¸åŒçš„â€¦â€¦

å°±åƒ M1 èŠ¯ç‰‡çš„å…¶ä»–éƒ¨åˆ†ä¸€æ ·ï¼Œ GPU æœ‰ä¸€ä¸ªç§°ä¸º "ASC" çš„åå¤„ç†å™¨ï¼Œè¿è¡Œç€è‹¹æœå›ºä»¶å¹¶ç®¡ç† GPU ã€‚è¿™ä¸ªåå¤„ç†å™¨æ˜¯ä¸€ä¸ªå®Œæ•´çš„ ARM64 CPU ï¼Œè¿è¡Œè‹¹æœä¸“æœ‰çš„å®æ—¶æ“ä½œç³»ç»Ÿï¼Œç§°ä¸º RTKit â€¦â€¦å®ƒè´Ÿè´£ä¸€åˆ‡äº‹æƒ…ï¼å®ƒè´Ÿè´£ç”µæºç®¡ç†ã€å‘½ä»¤è°ƒåº¦å’ŒæŠ¢å ã€æ•…éšœæ¢å¤ï¼Œç”šè‡³æ˜¯æ€§èƒ½è®¡æ•°å™¨ã€ç»Ÿè®¡æ•°æ®å’Œæ¸©åº¦æµ‹é‡ç­‰äº‹é¡¹ï¼äº‹å®ä¸Šï¼ŒmacOS çš„å†…æ ¸é©±åŠ¨ç¨‹åºæ ¹æœ¬ä¸ä¸ GPU ç¡¬ä»¶è¿›è¡Œé€šä¿¡ã€‚æ‰€æœ‰ä¸ GPU çš„é€šä¿¡éƒ½æ˜¯é€šè¿‡å›ºä»¶è¿›è¡Œçš„ï¼Œä½¿ç”¨å…±äº«å†…å­˜ä¸­çš„æ•°æ®ç»“æ„æ¥å‘Šè¯‰å®ƒè¯¥æ€ä¹ˆåšã€‚è€Œé‚£é‡Œæœ‰ç€å¾ˆå¤šè¿™æ ·çš„ç»“æ„â€¦â€¦

* **åˆå§‹åŒ–æ•°æ®** ç”¨æ¥é…ç½®å›ºä»¶ä¸­çš„ç”µæºç®¡ç†è®¾ç½®å’Œå…¶ä»– GPU å…¨å±€é…ç½®æ•°æ®ï¼Œä¸çŸ¥ä¸ºä½•è¿˜åŒ…æ‹¬äº†è‰²å½©ç©ºé—´è½¬æ¢è¡¨ï¼Ÿï¼è¿™äº›æ•°æ®ç»“æ„æœ‰è¿‘1000ä¸ªå­—æ®µï¼Œè€Œæˆ‘ä»¬ç”šè‡³è¿˜æ²¡æœ‰æŠŠå®ƒä»¬å…¨éƒ¨ææ¸…æ¥šï¼

* **æäº¤ç®¡é“** ç”¨äºåœ¨GPUä¸Šæ’é˜Ÿå·¥ä½œçš„ç¯å½¢ç¼“å†²åŒºã€‚

* **è®¾å¤‡æ§åˆ¶ä¿¡æ¯** ç”¨äºæ§åˆ¶å…¨å±€ GPU æ“ä½œã€‚

* **äº‹ä»¶æ¶ˆæ¯** å½“æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ (å¦‚å‘½ä»¤å®Œæˆæˆ–å¤±è´¥) ï¼Œå›ºä»¶ä¼šå°†å…¶é€å›é©±åŠ¨ç¨‹åºã€‚

* **ç»Ÿè®¡æ•°æ®**ã€**å›ºä»¶æ—¥å¿—**å’Œ**è¿½è¸ªä¿¡æ¯** ç”¨äºè®°å½• GPU çŠ¶æ€ä¿¡æ¯å’Œè°ƒè¯•ã€‚

* **å‘½ä»¤é˜Ÿåˆ—** ä»£è¡¨äº†å•ä¸ªåº”ç”¨çš„å¾…å¤„ç†çš„ GPU å·¥ä½œã€‚

* **ç¼“å†²ä¿¡æ¯**ã€**ç»Ÿè®¡æ•°æ®**å’Œ**é¡µåˆ—è¡¨ç»“æ„** ç”¨äºç®¡ç†[å¹³é“ºé¡¶ç‚¹ç¼“å†²åŒº](https://rosenzweig.io/blog/asahi-gpu-part-5.html)ã€‚

* **ä¸Šä¸‹æ–‡ç»“æ„**å’Œå…¶ä»–ä¸€äº›ä¸œè¥¿ è®© GPU å›ºä»¶è·Ÿè¸ªæ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚

* **é¡¶ç‚¹æ¸²æŸ“å‘½ä»¤** å®ƒå‘Šè¯‰ GPU çš„é¡¶ç‚¹å¤„ç†å’Œå¹³é“ºéƒ¨åˆ†å¦‚ä½•å¤„ç†æ¥è‡ªç”¨æˆ·ç©ºé—´çš„å‘½ä»¤å’Œç€è‰²å™¨ï¼Œä»¥è¿è¡Œæ•´ä¸ªæ¸²æŸ“é€šé“çš„é¡¶ç‚¹éƒ¨åˆ†ã€‚

* **ç‰‡æ®µæ¸²æŸ“å‘½ä»¤** å®ƒå‘Šè¯‰ GPU çš„å…‰æ …åŒ–å’Œç‰‡æ®µå¤„ç†éƒ¨åˆ†å¦‚ä½•å°†é¡¶ç‚¹å¤„ç†ä¸­çš„å¹³é“ºé¡¶ç‚¹æ•°æ®æ¸²æŸ“åˆ°å®é™…çš„å¸§ç¼“å†²åŒºä¸­ã€‚

ç”šè‡³æ¯”è¿™æ›´å¤æ‚! é¡¶ç‚¹å’Œç‰‡æ®µæ¸²æŸ“å‘½ä»¤å®é™…ä¸Šæ˜¯éå¸¸å¤æ‚çš„ç»“æ„ï¼Œå…¶ä¸­æœ‰è®¸å¤šåµŒå¥—ç»“æ„ï¼Œç„¶åæ¯ä¸ªå‘½ä»¤å®é™…ä¸Šéƒ½æœ‰ä¸€ä¸ªæŒ‡å‘æ›´å°çš„ç”± GPU è¿›è¡Œè§£é‡Šçš„å‘½ä»¤çš„"å¾®åºåˆ—"çš„æŒ‡é’ˆï¼Œå°±åƒä¸€ä¸ªå®šåˆ¶çš„è™šæ‹Ÿ CPU ï¼é€šå¸¸è¿™äº›å‘½ä»¤è®¾ç½®æ¸²æŸ“é€šé“ï¼Œç­‰å¾…å®ƒå®Œæˆï¼Œå¹¶è¿›è¡Œæ¸…ç†â€¦â€¦ä½†å®ƒä¹Ÿæ”¯æŒè¯¸å¦‚æ—¶é—´æˆ³å‘½ä»¤ã€ç”šè‡³æ˜¯å¾ªç¯å’Œç®—æœ¯çš„ä¸œè¥¿! è¿™çœŸæ˜¯å¤ªç–¯ç‹‚äº†! è€Œæ‰€æœ‰è¿™äº›ç»“æ„éƒ½éœ€è¦å¡«å…¥å…³äºå°†è¦æ¸²æŸ“çš„å†…å®¹çš„å¯†åˆ‡ç»†èŠ‚ï¼Œæ¯”å¦‚æŒ‡å‘æ·±åº¦å’Œæ¨¡æ¿ç¼“å†²åŒºçš„æŒ‡é’ˆã€å¸§ç¼“å†²åŒºçš„å¤§å°ã€æ˜¯å¦å¯ç”¨ MSAA (å¤šé‡é‡‡æ ·æŠ—é”¯é½¿) ä»¥åŠå¦‚ä½•é…ç½®ã€æŒ‡å‘ç‰¹å®šè¾…åŠ©ç€è‰²å™¨ç¨‹åºçš„æŒ‡é’ˆç­‰ç­‰ï¼Œä»¥åŠæ›´å¤šä¸œè¥¿ï¼

äº‹å®ä¸Šï¼ŒGPU å›ºä»¶ä¸ GPU MMU æœ‰ä¸€ç§å¥‡æ€ªçš„å…³ç³»ã€‚å®ƒä½¿ç”¨ç›¸åŒçš„é¡µè¡¨ï¼å›ºä»¶å®é™…ä¸Šé‡‡ç”¨äº† GPU MMU ä½¿ç”¨çš„ç›¸åŒçš„é¡µè¡¨åŸºæŒ‡é’ˆï¼Œå¹¶å°†å…¶é…ç½®ä¸ºå…¶ ARM64 é¡µè¡¨ã€‚å› æ­¤ï¼ŒGPU å†…å­˜å°±æ˜¯å›ºä»¶å†…å­˜! è¿™çœŸæ˜¯å¤ªç–¯ç‹‚äº†! è¿™é‡Œæœ‰ä¸€ä¸ªå…±äº«çš„"å†…æ ¸"åœ°å€ç©ºé—´ (ç±»ä¼¼äº Linux ä¸­çš„å†…æ ¸åœ°å€ç©ºé—´) ï¼Œç”±å›ºä»¶æœ¬èº«æ‰€ä½¿ç”¨ï¼Œä¹Ÿè¢«å®ƒä¸é©±åŠ¨çš„å¤§éƒ¨åˆ†é€šä¿¡æ‰€ä½¿ç”¨ã€‚ç„¶åä¸€äº›ç¼“å†²åŒºä¸ GPU ç¡¬ä»¶æœ¬èº«å…±äº«ï¼Œå¹¶æœ‰"ç”¨æˆ·ç©ºé—´"åœ°å€ï¼Œè¿™äº›åœ°å€ä¸ºä½¿ç”¨ GPU çš„æ¯ä¸ªåº”ç”¨ç¨‹åºæä¾›å•ç‹¬çš„åœ°å€ç©ºé—´ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°†æ‰€æœ‰è¿™äº›å¤æ‚çš„ä¸œè¥¿ç§»åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå¹¶è®©å®ƒè®¾ç½®æ‰€æœ‰è¿™äº›é¡¶ç‚¹/ç‰‡æ®µæ¸²æŸ“å‘½ä»¤ï¼Ÿä¸ï¼å› ä¸ºæ‰€æœ‰è¿™äº›ç»“æ„éƒ½å’Œå›ºä»¶æœ¬èº«ä¸€èµ·åœ¨å…±äº«çš„å†…æ ¸åœ°å€ç©ºé—´é‡Œï¼Œè€Œä¸”å®ƒä»¬æœ‰å¤§é‡çš„æŒ‡é’ˆï¼Œå®ƒä»¬åœ¨ä½¿ç”¨ GPU çš„ä¸åŒè¿›ç¨‹ä¹‹é—´æ˜¯ä¸éš”ç¦»çš„ï¼æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½è®©åº”ç”¨ç¨‹åºç›´æ¥è®¿é—®å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ä¼šç ´åå½¼æ­¤çš„æ¸²æŸ“â€¦â€¦æ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Alyssa åœ¨ macOS UAPI ä¸­å‘ç°äº†æ‰€æœ‰è¿™äº›æ¸²æŸ“ç»†èŠ‚â€¦â€¦

##  ç”¨ Python å†™ GPU é©±åŠ¨ï¼Ÿï¼

ç”±äºè·å¾—æ‰€æœ‰è¿™äº›ç»“æ„çš„æ­£ç¡®æ€§å¯¹äº GPU çš„å·¥ä½œå’Œå›ºä»¶çš„ä¸å´©æºƒè‡³å…³é‡è¦ï¼Œæˆ‘éœ€è¦ä¸€ç§æ–¹æ³•ï¼Œåœ¨æˆ‘è¿›è¡Œé€†å‘å·¥ç¨‹çš„æ—¶å€™èƒ½å¤Ÿå¿«é€Ÿåœ°å¯¹å®ƒä»¬è¿›è¡Œå®éªŒã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼ŒAsahi Linux é¡¹ç›®å·²ç»æœ‰äº†è¿™æ–¹é¢çš„å·¥å…·ã€‚m1n1 Python æ¡†æ¶! ç”±äºæˆ‘å·²ç»ä¸º m1n1 ç®¡ç†ç¨‹åºå†™äº†ä¸€ä¸ª GPU è·Ÿè¸ªå™¨ï¼Œå¹¶ç”¨ Python å¡«å†™äº†ç»“æ„å®šä¹‰ï¼Œæˆ‘å†³å®šæŠŠå®ƒç¿»è¿‡æ¥ï¼Œä½¿ç”¨ç›¸åŒçš„ç»“æ„å®šä¹‰å¼€å§‹å†™ä¸€ä¸ª Python GPU å†…æ ¸é©±åŠ¨ã€‚Python å¾ˆé€‚åˆåšè¿™ä»¶äº‹ï¼Œå› ä¸ºå®ƒå¾ˆå®¹æ˜“è¿­ä»£ã€‚æ›´æ£’çš„æ˜¯ï¼Œå®ƒå·²ç»å¯ä»¥æ²Ÿé€šåŸºæœ¬çš„ RTKit åè®®å¹¶è§£æå´©æºƒæ—¥å¿—ã€‚æˆ‘æ”¹è¿›äº†è¿™æ–¹é¢çš„å·¥å…·ï¼Œæ‰€ä»¥æˆ‘å¯ä»¥çœ‹åˆ°å›ºä»¶å´©æºƒæ—¶åˆ°åº•åœ¨åšä»€ä¹ˆã€‚è¿™ä¸€åˆ‡éƒ½é€šè¿‡åœ¨å¼€å‘æœºä¸Šè¿è¡Œè„šæœ¬æ¥å®Œæˆï¼Œå¼€å‘æœºé€šè¿‡ USB è¿æ¥åˆ° M1 æœºå™¨ä¸Šï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨æ¯æ¬¡æƒ³æµ‹è¯•ä»€ä¹ˆçš„æ—¶å€™è½»æ¾åœ°é‡æ–°å¯åŠ¨å®ƒï¼Œè€Œä¸”æµ‹è¯•å‘¨æœŸéå¸¸å¿«!

èµ·åˆï¼Œé©±åŠ¨çš„å¤§éƒ¨åˆ†å†…å®¹å®é™…ä¸Šåªæ˜¯[ä¸€å †ç¡¬ç¼–ç çš„ç»“æ„](https://github.com/AsahiLinux/m1n1/blob/main/proxyclient/experiments/agx_1tri.py)ï¼Œä½†æœ€ç»ˆæˆ‘è®¾æ³•æŠŠå®ƒä»¬å¼„å¯¹äº†ï¼Œå¹¶æ¸²æŸ“å‡ºä¸€ä¸ªä¸‰è§’å½¢ï¼

ä¸è¿‡è¿™åªæ˜¯ä¸€ä¸ªé»‘è¿›å»çš„æ¼”ç¤ºâ€¦â€¦åœ¨å¼€å§‹åš Linux å†…æ ¸é©±åŠ¨ä¹‹å‰ï¼Œæˆ‘æƒ³ç¡®ä¿æˆ‘å¯¹ä¸€åˆ‡éƒ½æœ‰è¶³å¤Ÿçš„äº†è§£ï¼Œä»¥ä¾¿æ­£ç¡®è®¾è®¡é©±åŠ¨ã€‚åªæ¸²æŸ“ä¸€å¸§å·²ç»è¶³å¤Ÿå®¹æ˜“ï¼Œä½†æˆ‘å¸Œæœ›èƒ½å¤Ÿæ¸²æŸ“å¤šå¸§ï¼Œå¹¶æµ‹è¯•è¯¸å¦‚å¹¶å‘å’ŒæŠ¢å çš„ä¸œè¥¿ã€‚æ‰€ä»¥æˆ‘çœŸçš„éœ€è¦ä¸€ä¸ªçœŸæ­£çš„"å†…æ ¸é©±åŠ¨"â€¦â€¦ä½†è¿™åœ¨ Python ä¸­æ˜¯ä¸å¯èƒ½åšåˆ°çš„ï¼Œå¯¹å—ï¼Ÿï¼

å®é™…ä¸Šï¼ŒMesa æœ‰ä¸€ä¸ªå«åš [drm-shim](https://gitlab.freedesktop.org/mesa/mesa/-/tree/main/src/drm-shim) çš„ä¸œè¥¿ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿ Linux DRM å†…æ ¸æ¥å£çš„åº“ï¼Œé€šè¿‡ç”¨æˆ·ç©ºé—´çš„ä¸€äº›å‡å¤„ç†æ¥ä»£æ›¿å®ƒã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒè¢«ç”¨äºåƒç€è‰²å™¨ CI è¿™æ ·çš„äº‹æƒ…ï¼Œä½†å®ƒä¹Ÿå¯ä»¥ç”¨æ¥åšæ›´ç–¯ç‹‚çš„äº‹æƒ…â€¦â€¦æ‰€ä»¥â€¦â€¦å¦‚æœæˆ‘åœ¨ drm_shim é‡Œé¢å¡è¿›ä¸€ä¸ª Python è§£é‡Šå™¨ï¼Œå¹¶ä»å®ƒé‚£é‡Œè°ƒç”¨æˆ‘çš„æ•´ä¸ª Python é©±åŠ¨åŸå‹ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ

æˆ‘èƒ½å¦åœ¨ Mesa ä¸Šè¿è¡Œ [Inochi2D](https://inochi2d.com/) ï¼Œä½¿ç”¨ Alyssa çš„ Mesa M1 GPU é©±åŠ¨ï¼Œåœ¨ drm-shimä¸Šï¼Œè¿è¡ŒåµŒå…¥çš„ Python è§£é‡Šå™¨ï¼Œåœ¨ m1n1 å¼€å‘æ¡†æ¶ä¸Šå‘æˆ‘çš„ Python åŸå‹é©±åŠ¨å‘é€å‘½ä»¤ï¼Œé€šè¿‡ USB ä¸çœŸæ­£çš„ M1 æœºå™¨é€šä¿¡ï¼Œæ¥å›å‘é€æ‰€æœ‰æ•°æ®ï¼Œä»¥ä¾¿é©±åŠ¨ GPU å›ºä»¶å’Œè‡ªæˆ‘æ¸²æŸ“ï¼Ÿè¿™å°†æ˜¯å¤šä¹ˆè’è°¬çš„äº‹æƒ…ï¼Ÿ

æ›´è’è°¬çš„æ˜¯å®ƒçœŸçš„å®ç°äº†ï¼âœ¨

##  ä¸€ç§ä¸º Linux å†…æ ¸è€Œç”Ÿçš„æ–°è¯­è¨€

æœ‰äº†è¿™ä¸ªææ€–çš„ Mesa+Python é©±åŠ¨æ ˆï¼Œæˆ‘å¼€å§‹å¯¹æœ€ç»ˆçš„å†…æ ¸é©±åŠ¨å¿…é¡»å¦‚ä½•å·¥ä½œä»¥åŠå®ƒå¿…é¡»åšä»€ä¹ˆæœ‰äº†æ›´å¥½çš„è®¤è¯†ã€‚å®ƒå¿…é¡»è¦åšå¾ˆå¤šäº‹æƒ…ï¼æ²¡æœ‰åŠæ³•ç»•è¿‡æ¶‰åŠçš„100å¤šä¸ªæ•°æ®ç»“æ„â€¦â€¦å¦‚æœå‘ç”Ÿä»»ä½•é—®é¢˜ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½ä¼šåæ‰ï¼å›ºä»¶ä¸å¯¹ä»»ä½•ä¸œè¥¿è¿›è¡Œå®Œå¤‡æ£€æŸ¥ï¼ˆå¯èƒ½æ˜¯ä¸ºäº†æ€§èƒ½ï¼‰ï¼Œå¦‚æœå®ƒé‡åˆ°ä»»ä½•æŸåçš„æŒ‡é’ˆæˆ–æ•°æ®ï¼Œå®ƒå°±ä¼šå´©æºƒæˆ–ç›²ç›®åœ°è¦†ç›–æ•°æ®ï¼æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¦‚æœå›ºä»¶å´©æºƒäº†ï¼Œå”¯ä¸€çš„æ¢å¤æ–¹æ³•å°±æ˜¯å®Œå…¨é‡å¯æœºå™¨ï¼ğŸ˜±

Linux å†…æ ¸çš„ DRM é©±åŠ¨æ˜¯ç”¨ C è¯­è¨€ç¼–å†™çš„ï¼Œè€Œ C è¯­è¨€å¹¶ä¸æ˜¯ç¼–å†™å¤æ‚æ•°æ®ç»“æ„ç®¡ç†çš„æœ€å¥½è¯­è¨€ã€‚æˆ‘å¿…é¡»æ‰‹åŠ¨è·Ÿè¸ªæ¯ä¸€ä¸ª GPU å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¦‚æœæˆ‘çŠ¯äº†ä»»ä½•é”™è¯¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´éšæœºå´©æºƒï¼Œç”šè‡³æ˜¯å®‰å…¨æ¼æ´ã€‚æˆ‘è¯¥å¦‚ä½•æˆ˜èƒœè¿™äº›å›°éš¾å‘¢ï¼Ÿæœ‰å¤ªå¤šçš„äº‹æƒ…ä¼šå‡ºé”™ï¼Œè€Œ C è¯­è¨€ä¸€ç‚¹ä¹Ÿä¸èƒ½å¸®åŠ©ä½ è§£å†³è¿™äº›é—®é¢˜ï¼

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è¿˜å¿…é¡»æ”¯æŒå¤šä¸ªå›ºä»¶ç‰ˆæœ¬ï¼Œè€Œè‹¹æœå…¬å¸å¹¶æ²¡æœ‰åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­ä¿æŒå›ºä»¶ç»“æ„å®šä¹‰çš„ç¨³å®šï¼ä½œä¸ºå®éªŒï¼Œæˆ‘å·²ç»æ·»åŠ äº†å¯¹ç¬¬äºŒä¸ªç‰ˆæœ¬çš„æ”¯æŒï¼Œæˆ‘æœ€ç»ˆä¸å¾—ä¸å¯¹æ•°æ®ç»“æ„åšäº†100å¤šå¤„æ”¹åŠ¨ã€‚åœ¨ Python æ¼”ç¤ºä¸­ï¼Œæˆ‘å¯ä»¥ç”¨ä¸€äº›èŠ±å“¨çš„å…ƒç¼–ç¨‹æ¥ä½¿ç»“æ„å­—æ®µä»¥ç‰ˆæœ¬å·ä¸ºæ¡ä»¶â€¦â€¦ä½† C è¯­è¨€æ²¡æœ‰è¿™æ ·çš„ä¸œè¥¿ã€‚ä½ å¿…é¡»ä½¿ç”¨ä¸€äº›å°æŠ€å·§ï¼Œæ¯”å¦‚ç”¨ä¸åŒçš„ `#define` å¤šæ¬¡ç¼–è¯‘æ•´ä¸ªé©±åŠ¨ç¨‹åºï¼

å°±åœ¨è¿™æ—¶æœ‰ä¸€ç§æ–°çš„è¯­è¨€å‡ºç°äº†â€¦â€¦

å¤§çº¦åœ¨åŒä¸€æ—¶é—´ï¼Œå…³äº Rust å³å°†è¢« Linux å†…æ ¸æ­£å¼é‡‡ç”¨çš„ä¼ è¨€å¼€å§‹å‡ºç°äº†ã€‚[Rust for Linux](https://github.com/Rust-for-Linux) é¡¹ç›®å‡ å¹´æ¥ä¸€ç›´è‡´åŠ›äºæ·»åŠ å®˜æ–¹æ”¯æŒï¼Œè€Œä¸”çœ‹èµ·æ¥ä»–ä»¬çš„å·¥ä½œå¯èƒ½å¾ˆå¿«å°±ä¼šè¢«åˆå¹¶ã€‚æˆ‘å¯ä»¥â€¦â€¦æˆ‘å¯ä»¥ç”¨ Rust ç¼–å†™ GPU é©±åŠ¨å—ï¼Ÿ

æˆ‘å¯¹ Rust æ²¡æœ‰å¤ªå¤šçš„ç»éªŒï¼Œä½†å°±æˆ‘æ‰€äº†è§£çš„æ¥çœ‹ï¼Œå®ƒä¼¼ä¹æ˜¯ä¸€ç§ç¼–å†™ GPU é©±åŠ¨çš„æ›´å¥½çš„è¯­è¨€ï¼æˆ‘å¯¹ä¸¤ä»¶äº‹ç‰¹åˆ«æ„Ÿå…´è¶£ï¼šä¸€æ˜¯å®ƒæ˜¯å¦èƒ½å¸®åŠ©æˆ‘å¯¹ GPU å›ºä»¶ç»“æ„çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œå»ºæ¨¡ (å°½ç®¡è¿™äº›ç»“æ„ä¸ GPU æŒ‡é’ˆç›¸è¿ï¼Œè€Œä» CPU çš„è§’åº¦æ¥çœ‹ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„æŒ‡é’ˆ) ï¼›äºŒæ˜¯ Rust å®æ˜¯å¦èƒ½è§£å†³å¤šç‰ˆæœ¬é—®é¢˜ã€‚å› æ­¤ï¼Œåœ¨ç›´æ¥è¿›å…¥å†…æ ¸å¼€å‘ä¹‹å‰ï¼Œæˆ‘å‘ Rust ä¸“å®¶å¯»æ±‚å¸®åŠ©ï¼Œç”¨ç®€å•çš„ç”¨æˆ·ç©ºé—´ Rust åˆ¶ä½œäº†ä¸€ä¸ª GPU å¯¹è±¡æ¨¡å‹çš„[ç©å…·åŸå‹](https://github.com/asahilina/gpu-rust-playground)ã€‚Rust ç¤¾åŒºéå¸¸å‹å¥½ï¼Œæœ‰å‡ ä¸ªäººå¸®åŠ©æˆ‘å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œã€‚æ²¡æœ‰ä½ ä»¬çš„å¸®åŠ©ï¼Œæˆ‘æ˜¯ä¸å¯èƒ½åšåˆ°çš„! â¤

è€Œä¸”çœ‹èµ·æ¥å®ƒå¯ä»¥å·¥ä½œ! ä½†æ˜¯ Rust ä»ç„¶æ²¡æœ‰è¢« Linux ä¸»çº¿æ‰€æ¥å—â€¦â€¦è€Œä¸”æˆ‘å°†è¿›å…¥ä¸€ä¸ªæœªçŸ¥çš„é¢†åŸŸï¼Œä»æ¥æ²¡æœ‰äººåšè¿‡è¿™æ ·çš„äº‹æƒ…ã€‚è¿™å°†æ˜¯ä¸€åœºèµŒåšâ€¦â€¦ä½†å½“æˆ‘è¶Šè€ƒè™‘è¿™ä»¶äº‹ï¼Œæˆ‘çš„å†…å¿ƒå°±è¶Šå‘Šè¯‰æˆ‘ Rust æ˜¯ä¸ªå¥½åŠæ³•ã€‚æˆ‘å’Œ Linux DRM çš„ç»´æŠ¤è€…ä»¥åŠå…¶ä»–ä¸€äº›äººèŠè¿‡è¿™ä¸ªé—®é¢˜ï¼Œä»–ä»¬ä¼¼ä¹å¾ˆçƒ­æƒ…ï¼Œæˆ–è€…è‡³å°‘æ¥å—äº†è¿™ä¸ªæƒ³æ³•ï¼Œæ‰€ä»¥â€¦â€¦

æ‰€ä»¥æˆ‘å†³å®šå»åšè¿™ä»¶äº‹ï¼

##  Rust å¼€ç«¯

ç”±äºè¿™å°†æ˜¯ç¬¬ä¸€ä¸ª Linux Rust GPU å†…æ ¸é©±åŠ¨ï¼Œæˆ‘æœ‰å¾ˆå¤šå·¥ä½œè¦åšï¼æˆ‘ä¸ä»…è¦ç¼–å†™é©±åŠ¨æœ¬èº«ï¼Œè¿˜è¦ä¸º Linux DRM å›¾å½¢å­ç³»ç»Ÿç¼–å†™ Rust æŠ½è±¡ã€‚è™½ç„¶ Rust å¯ä»¥ç›´æ¥è°ƒç”¨ C å‡½æ•°ï¼Œä½†è¿™æ ·åšå¹¶æ²¡æœ‰ Rust çš„ä»»ä½•å®‰å…¨ä¿è¯ã€‚å› æ­¤ï¼Œä¸ºäº†ä» Rust ä¸­å®‰å…¨åœ°ä½¿ç”¨ C ä»£ç ï¼Œé¦–å…ˆä½ å¿…é¡»åŒ…è£…å‡ºä¸€ä¸ªå®‰å…¨çš„ Rust å¼ APIã€‚ç»“æœæˆ‘ä»…æ˜¯ä¸ºäº†æŠ½è±¡å°±å†™äº†å°†è¿‘1500è¡Œçš„ä»£ç ã€‚è€Œä¸”ä¸ºäº†è·å¾—ä¸€ä¸ªå¥½çš„ã€å®‰å…¨çš„è®¾è®¡ï¼ŒåˆèŠ±äº†å¾ˆå¤šæ—¶é—´è¿›è¡Œæ€è€ƒå’Œé‡å†™ï¼

8æœˆ18æ—¥ï¼Œæˆ‘å¼€å§‹ç¼–å†™ [Rust é©±åŠ¨](https://github.com/AsahiLinux/linux/commit/16080191f08876c358692f34bafc5afae6b75e00)ã€‚æœ€åˆï¼Œå®ƒä¾é  C ä»£ç æ¥å¤„ç† MMU (éƒ¨åˆ†æ˜¯ä» Panfrost é©±åŠ¨ä¸­å¤åˆ¶çš„) ï¼Œå°½ç®¡åæ¥æˆ‘å†³å®šç”¨ Rust [é‡å†™](https://github.com/AsahiLinux/linux/commit/bc43e9a4fd5e5b3b91243f0f729beed4af2b010d)æ‰€æœ‰çš„ä»£ç ã€‚åœ¨æ¥ä¸‹æ¥çš„å‡ å‘¨é‡Œï¼Œæˆ‘åŠ å…¥äº†æˆ‘ä¹‹å‰è®¾è®¡çš„ Rust GPU å¯¹è±¡ç³»ç»Ÿï¼Œç„¶åç”¨ Rust é‡æ–°å®ç°äº† Python æ¼”ç¤ºé©±åŠ¨çš„æ‰€æœ‰å…¶ä»–éƒ¨åˆ†ã€‚

æˆ‘è¶Šæ˜¯ä½¿ç”¨ Rust ï¼Œå°±è¶Šæ˜¯çˆ±ä¸Šäº†å®ƒï¼å®ƒç»™æˆ‘çš„æ„Ÿè§‰å°±åƒæ˜¯ Rust çš„è®¾è®¡å¼•å¯¼ä½ èµ°å‘å¥½çš„æŠ½è±¡å’Œè½¯ä»¶è®¾è®¡ã€‚ç¼–è¯‘å™¨éå¸¸æŒ‘å‰”ï¼Œç„¶è€Œä»£ç ä¸€æ—¦ç¼–è¯‘æˆåŠŸï¼Œå°±ä¼šç»™ä½ ä¿¡å¿ƒè§‰å¾—å®ƒèƒ½å¯é åœ°å·¥ä½œã€‚æœ‰æ—¶æˆ‘åœ¨è®©ç¼–è¯‘å™¨è®¤åŒæˆ‘è¯•å›¾ä½¿ç”¨çš„è®¾è®¡æ—¶é‡åˆ°å›°éš¾ï¼Œç„¶åæˆ‘å°±æ„è¯†åˆ°è¿™ä¸ªè®¾è®¡æœ‰æ ¹æœ¬æ€§çš„é—®é¢˜ï¼

é©±åŠ¨ç¨‹åºæ…¢æ…¢åœ°æˆå‹äº†ã€‚9æœˆ24æ—¥ï¼Œæˆ‘ç»ˆäºè®© kmscube æ¸²æŸ“äº†ç¬¬ä¸€ä¸ªç«‹æ–¹ä½“ï¼Œç”¨æˆ‘å…¨æ–°ç¼–å†™çš„ Rust é©±åŠ¨ç¨‹åºï¼

æ¥ç€ï¼Œç¥å¥‡çš„äº‹æƒ…å‘ç”Ÿäº†ã€‚

ä»…ä»…å‡ å¤©åï¼Œæˆ‘å°±èƒ½å¤Ÿè¿è¡Œä¸€ä¸ªå®Œæ•´çš„ GNOME æ¡Œé¢ä¼šè¯ï¼

##  Rust å¤ªç¥å¥‡äº†ï¼

é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“ä½ å†™ä¸€ä¸ªåƒè¿™æ ·å¤æ‚çš„å…¨æ–°å†…æ ¸é©±åŠ¨ç¨‹åºæ—¶ï¼Œè¯•å›¾ä»ç®€å•çš„æ¼”ç¤ºåº”ç”¨ç¨‹åºåˆ°å¤šä¸ªåº”ç”¨ç¨‹åºåŒæ—¶ä½¿ç”¨ GPU çš„å®Œæ•´æ¡Œé¢ï¼Œç»“æœä¼šå¼•å‘å„ç§ç«èµ›æ¡ä»¶ã€å†…å­˜æ³„æ¼ã€ä½¿ç”¨åé‡Šæ”¾é—®é¢˜ï¼Œä»¥åŠæ‰€æœ‰çš„ç³Ÿç³•æƒ…å†µã€‚

ä½†æ‰€æœ‰è¿™äº›â€¦â€¦éƒ½æ²¡æœ‰å‘ç”Ÿï¼æˆ‘åªéœ€è¦ä¿®å¤ä¸€äº›é€»è¾‘é”™è¯¯å’Œå†…å­˜ç®¡ç†ä»£ç æ ¸å¿ƒä¸­çš„ä¸€ä¸ªé—®é¢˜ï¼Œç„¶åå…¶ä»–æ‰€æœ‰çš„ä¸œè¥¿éƒ½ç¨³å®šåœ°å·¥ä½œäº†ï¼Rust çœŸçš„å¾ˆç¥å¥‡ï¼å®ƒçš„å®‰å…¨ç‰¹æ€§æ„å‘³ç€ï¼Œåªè¦åœ¨å°‘æ•°ä¸å®‰å…¨çš„éƒ¨åˆ†æ²¡æœ‰é—®é¢˜ï¼Œé©±åŠ¨çš„è®¾è®¡å°±èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨å’Œå†…å­˜å®‰å…¨ã€‚å®ƒçœŸçš„èƒ½å¼•å¯¼ä½ èµ°å‘ä¸ä»…æ˜¯å®‰å…¨è€Œä¸”æ˜¯å¥½çš„è®¾è®¡ã€‚

å½“ç„¶ï¼Œä»£ç ä¸­æ€»æœ‰ä¸€äº›ä¸å®‰å…¨çš„éƒ¨åˆ†ï¼Œä½†ç”±äº Rust è®©ä½ ä»å®‰å…¨çš„æŠ½è±¡è§’åº¦è€ƒè™‘é—®é¢˜ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“é™ä½å¯èƒ½å‡ºç° bug çš„åŒºåŸŸçš„è¡¨é¢ç§¯ã€‚ä»ç„¶å­˜åœ¨ä¸€äº›å®‰å…¨é—®é¢˜! ä¾‹å¦‚ï¼Œæˆ‘çš„DRM å†…å­˜ç®¡ç†æŠ½è±¡ä¸­æœ‰ä¸€ä¸ª bug ï¼Œå¯èƒ½å¯¼è‡´åˆ†é…å™¨åœ¨æ‰€æœ‰åˆ†é…è¢«é‡Šæ”¾ä¹‹å‰å°±è¢«é‡Šæ”¾äº†ã€‚ä½†æ˜¯ï¼Œç”±äºè¿™äº›é”™è¯¯æ˜¯é’ˆå¯¹æŸä¸€æ®µä»£ç çš„ï¼Œå®ƒä»¬å¾€å¾€æ˜¯æ˜¾è€Œæ˜“è§çš„ä¸»è¦é—®é¢˜ï¼ˆå¹¶ä¸”å¯ä»¥åœ¨ä»£ç å®¡æŸ¥ä¸­è¢«å®¡è®¡æˆ–æ•è·ï¼‰ï¼Œè€Œä¸æ˜¯è·¨è¶Šæ•´ä¸ªé©±åŠ¨çš„éš¾ä»¥æ•è·çš„ç«æ€æ¡ä»¶æˆ–é”™è¯¯ç”¨ä¾‹ã€‚é€šè¿‡åªéœ€è¦å•ç‹¬è€ƒè™‘ç‰¹å®šçš„ä»£ç æ¨¡å—å’Œå®‰å…¨ç›¸å…³çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯å®ƒä»¬ä¸å…¶ä»–ä¸œè¥¿çš„ç›¸äº’ä½œç”¨ï¼Œä½ æœ€ç»ˆå°†å¯èƒ½çš„é”™è¯¯æ•°é‡å‡å°‘åˆ°ä¸€ä¸ªå¾ˆå°çš„æ•°å­—ã€‚é™¤éä½ è¯•è¿‡ Rust ï¼Œå¦åˆ™è¿™å¾ˆéš¾æè¿°ï¼Œä½†å®ƒå¸¦æ¥äº†å·¨å¤§çš„å˜åŒ–ï¼

å“¦ï¼Œè¿˜æœ‰é”™è¯¯å’Œæ¸…ç†å¤„ç†ï¼ æ‰€æœ‰åœ¨ C è¯­è¨€ä¸­æ¸…ç†èµ„æºçš„å®¹æ˜“å‡ºé”™çš„ `goto` `cleanup` é£æ ¼çš„é”™è¯¯å¤„ç†åœ¨ Rust ä¸­éƒ½æ¶ˆå¤±äº†ã€‚å³ä½¿åªæ˜¯è¿™æ ·ä¹Ÿæ˜¯å€¼å¾—çš„ã€‚æ›´ä¸ç”¨è¯´ä½ è¿˜å¯ä»¥å¾—åˆ°çœŸæ­£çš„è¿­ä»£å™¨ï¼Œå¼•ç”¨è®¡æ•°æ˜¯è‡ªåŠ¨çš„ï¼â¤

##  åˆä½œçš„åŠ›é‡

éšç€å†…æ ¸é©±åŠ¨æ­¥å…¥æ­£è½¨ï¼Œæ˜¯æ—¶å€™ä¸ Alyssa è”æ‰‹å¼€å§‹åˆä½œäº†ï¼å¥¹ä¸å†å—é™äºåªåœ¨ macOS ä¸Šæµ‹è¯•ï¼Œå¼€å§‹å¯¹ Mesa é©±åŠ¨è¿›è¡Œé‡å¤§æ”¹è¿›ï¼æˆ‘ç”šè‡³è¿˜å¸®äº†ç‚¹å°å¿™^^

æˆ‘ä»¬åœ¨ XDC2022 ä¸Šåšäº†ä¸€æ¬¡[è”åˆæ¼”è®²](https://www.youtube.com/watch?v=SDJCzJ1ETsM)ï¼Œå½“æ—¶æˆ‘ä»¬ç”¨æˆ‘ä»¬çš„é©±åŠ¨åœ¨ M1 ä¸Šè¿è¡Œäº†æ•´ä¸ªæ¼”è®²! ä»é‚£æ—¶èµ·ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨åŠªåŠ›ä¸ºä¸¤è¾¹å¢åŠ æ–°çš„åŠŸèƒ½ï¼Œä¿®å¤é”™è¯¯ï¼Œå¹¶æ”¹è¿›æ€§èƒ½ã€‚æˆ‘åœ¨å†…æ ¸æ–¹é¢å¢åŠ äº†å¯¹ M1 Pro/Max/Ultra ç³»åˆ—å’Œ M2 çš„æ”¯æŒï¼Œä»¥åŠæ›´å¤šæ›´å¥½çš„è°ƒè¯•å·¥å…·å’Œå†…å­˜åˆ†é…æ€§èƒ½æ”¹è¿›ã€‚å¥¹ä¸€ç›´åœ¨ç¨³æ­¥æé«˜ GL çš„ä¸€è‡´æ€§ï¼ŒOpenGL ES 2.0 çš„ä¸€è‡´æ€§å‡ ä¹å·²ç»å®Œæˆï¼Œ3.0 çš„ä¸€è‡´æ€§è¶…è¿‡96%ï¼å¥¹è¿˜å¢åŠ äº†è®¸å¤šæ–°çš„åŠŸèƒ½å’Œæ€§èƒ½æ”¹è¿›ï¼Œä»Šå¤©ä½ å¯ä»¥åœ¨ 4K ä¸‹ç©åƒ Xonotic å’Œ Quake è¿™æ ·çš„æ¸¸æˆï¼

ç”±äº GPU çš„ç”µæºç®¡ç†æ˜¯ç”±å›ºä»¶å¤„ç†çš„ï¼Œæ‰€æœ‰è¿™äº›éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚æˆ‘åœ¨ GNOME ä¼šè¯ä¸­ä»¥ 1080p æµ‹è¯•äº† Xonotic ï¼Œé¢„è®¡ç”µæ± è¿è¡Œæ—¶é—´è¶…è¿‡8å°æ—¶ï¼ ğŸš€

å¯¹ Vulkan çš„æ”¯æŒæƒ…å†µå¦‚ä½•ï¼Ÿåˆ«æ‹…å¿ƒâ€¦â€¦ [Ella](https://tech.lgbt/@ella) æ­£åœ¨åŠªåŠ›è§£å†³è¿™ä¸ªé—®é¢˜! âœ¨âœ¨

##  æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

å‰é¢è¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°! æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„ UAPI ä»ç„¶æ˜¯ä¸€ä¸ªåŸå‹ï¼Œæœ‰å¾ˆå¤šæ–°çš„åŠŸèƒ½éœ€è¦æ·»åŠ æˆ–é‡æ–°è®¾è®¡ï¼Œä»¥ä¾¿åœ¨æœªæ¥æ”¯æŒä¸€ä¸ªå®Œæ•´çš„ Vulkan é©±åŠ¨ã€‚ç”±äº Linux è§„å®š UAPI éœ€è¦ä¿æŒç¨³å®šï¼Œå¹¶åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­å‘åå…¼å®¹ (ä¸ macOS ä¸åŒ)ï¼Œè¿™æ„å‘³ç€å†…æ ¸é©±åŠ¨åœ¨è®¸å¤šä¸ªæœˆå†…ä¸ä¼šå‘ä¸Šæ¸¸å‘å±•ï¼Œç›´åˆ°æˆ‘ä»¬å¯¹ GPU æ¸²æŸ“å‚æ•°æœ‰äº†æ›´å…¨é¢çš„äº†è§£ï¼Œå¹¶å®ç°äº† Vulkan æ‰€éœ€çš„æ‰€æœ‰æ–°è®¾è®¡åŠŸèƒ½ã€‚ç›®å‰çš„ UAPI ä¹Ÿæœ‰æ€§èƒ½é™åˆ¶......å®ƒç”šè‡³è¿˜ä¸èƒ½åœ¨ CPU å¤„ç†çš„åŒæ—¶è¿è¡Œ GPU æ¸²æŸ“ï¼

å½“ç„¶ï¼Œåœ¨ç”¨æˆ·ç©ºé—´æ–¹é¢è¿˜æœ‰å¾ˆå¤šå·¥ä½œè¦åšï¼Œæ”¹å–„ä¸€è‡´æ€§å’Œæ€§èƒ½ï¼Œå¹¶å¢åŠ å¯¹æ›´å¤š GL æ‰©å±•å’ŒåŠŸèƒ½çš„æ”¯æŒï¼ä¸€äº›åŠŸèƒ½ï¼Œå¦‚é•¶åµŒå’Œå‡ ä½•ç€è‰²å™¨çš„å®ç°éå¸¸æ£˜æ‰‹ (å› ä¸ºå®ƒä»¬éœ€è¦éƒ¨åˆ†æˆ–å®Œå…¨ä»¿çœŸ)ï¼Œæ‰€ä»¥åœ¨ç›¸å½“é•¿çš„ä¸€æ®µæ—¶é—´å†…ä¸è¦æŒ‡æœ›å®Œå…¨çš„ OpenGL 3.2+ ã€‚

ä½†æ˜¯ï¼Œå³ä½¿æœ‰è¿™äº›é™åˆ¶ï¼Œä»Šå¤©çš„é©±åŠ¨ç¨‹åºä¹Ÿå¯ä»¥ç¨³å®šåœ°è¿è¡Œæ¡Œé¢ï¼Œè€Œä¸”æ€§èƒ½æ¯å‘¨éƒ½åœ¨æé«˜ï¼Wayland ç°åœ¨åœ¨è¿™äº›æœºå™¨ä¸Šè¿è¡Œå¾—éå¸¸æµç•…ï¼Œå°±åƒåŸç”Ÿçš„ macOS æ¡Œé¢ä¸€æ ·! å‡ å¤©å‰æˆ‘å¯¹æ˜¾ç¤ºé©±åŠ¨åšäº†ä¸€äº›æ”¹è¿›ï¼ŒXorg ä¹Ÿè¿è¡Œå¾—å¾ˆå¥½ï¼Œå°½ç®¡ç”±äº Xorg çš„è®¾è®¡é™åˆ¶ï¼Œä½ å¯ä»¥é¢„æ–™åˆ°ä¼šå‡ºç°æ’•è£‚å’Œ vsync é—®é¢˜ã€‚Wayland ç¡®å®æ˜¯æ–°å¹³å°ä¸Šçš„æœªæ¥! ğŸ’«

é‚£ä¹ˆä½ å¯ä»¥ä»å“ªé‡Œè·å¾—å®ƒå‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ²¡åˆ°é‚£ä¸€æ­¥å‘¢! ç°åœ¨ï¼Œé©±åŠ¨ç¨‹åºæ ˆçš„æ„å»ºå’Œå®‰è£…å¾ˆå¤æ‚ (ä½ éœ€è¦å®šåˆ¶ m1n1 ã€å†…æ ¸å’Œ mesa çš„æ„å»º) ï¼Œæ‰€ä»¥è¯·å†ç­‰ä¸€ç­‰å§ æˆ‘ä»¬è¿˜æœ‰ä¸€äº›é—®é¢˜éœ€è¦è§£å†³â€¦â€¦ä½†æˆ‘ä»¬å¸Œæœ›åœ¨å¹´åº•å‰ï¼Œå¯ä»¥æŠŠå®ƒä½œä¸ºä¸€ä¸ªå¯é€‰æ‹©çš„æµ‹è¯•ç‰ˆæœ¬å¸¦åˆ° Asahi Linux ä¸Šï¼ âœ¨âœ¨

å¦‚æœä½ å¯¹å…³æ³¨æˆ‘åœ¨ GPU ä¸Šçš„å·¥ä½œæ„Ÿå…´è¶£ï¼Œä½ å¯ä»¥å…³æ³¨æˆ‘ [@lina@vt.social](https://vt.social/@lina) æˆ–è®¢é˜…æˆ‘çš„ [YouTubeé¢‘é“](https://youtube.com/AsahiLina) ï¼æ˜å¤©ï¼Œæˆ‘å°†å…¨åŠ›å¼„æ¸… M1 Pro/Max/Ultra å’Œ M2 çš„åŠŸè€—è®¡ç®—ï¼Œæˆ‘å¸Œæœ›èƒ½åœ¨é‚£é‡Œè§åˆ°ä½ ! âœ¨

å¦‚æœä½ æƒ³æ”¯æŒæˆ‘çš„å·¥ä½œï¼Œä½ å¯ä»¥åœ¨ GitHub ä¸Šå‘ marcan çš„ Asahi Linux è¿›è¡Œèµ„é‡‘æèµ  [Github Sponsors](http://github.com/sponsors/marcan) æˆ– [Patreon](https://patreon.com/marcan)ï¼Œè¿™å°†æœ‰åŠ©äºæˆ‘çš„å·¥ä½œ! å¦‚æœä½ æœŸå¾…ä¸€ä¸ª Vulkan é©±åŠ¨ï¼Œè¯·æŸ¥çœ‹ Ella çš„ [GitHub Sponsors](https://github.com/sponsors/Ella-0) é¡µé¢! Alyssa è‡ªå·±ä¸æ¥å—ææ¬¾ï¼Œä½†å¥¹å¸Œæœ›ä½ èƒ½æç»™åƒ[è½¯ä»¶è‡ªç”±ä¿æŠ¤åä¼š](https://sfconservancy.org/)è¿™æ ·çš„æ…ˆå–„æœºæ„ã€‚(è™½ç„¶ä¹Ÿè®¸æœ‰ä¸€å¤©æˆ‘ä¼šè¯´æœå¥¹è®©æˆ‘ç»™å¥¹ä¹°ä¸€ä¸ªM2...^^;;\)

##  å…³äºè¯‘æ–‡

> æœ¬æ–‡çš„ç¿»è¯‘å’Œè½¬è½½å‡å·²ç»è¿‡åŸä½œè€… Asahi Lina çš„è®¸å¯<br>åŸæ–‡åœ°å€ï¼šhttps://asahilinux.org/2022/11/tales-of-the-m1-gpu/<br>

![](https://oss.yuchanns.xyz/images/image_cb7c955c-488c-4c1c-b118-665c74902cdf.png)

